<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <title>QBet</title>
    <link rel="stylesheet" href="index.css">
    <meta name="theme-color" content="#7952b3">
</head>

<body>
    <div class="modal fade" id="howis" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel">But how...?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h3>Nasıl oynarım?</h3>
                    <p>Sitede sadece bir tane bahis olur, ana sayfada görebilirsiniz. Tek yapmanız gereken bahsin
                        altındaki seceneklerden kazanacagını düşündügüz seçenek
                        için verilen adrese, cüzdanınızdan istediginiz kadar 777 gondermek. Hepsi bu.</p>

                    <h3>Nasıl hesaplanır</h3>
                    <p>Bahis icin butun seceneklerin adreslerine gonderilen butun koinler toplanır. Kasa bu toplamın %2
                        sini alır. Kalan toplam kazanan secenege gonderenler
                        arasında, gönderdikleri miktar ile orantılı olarak paylaştırılır.</p>

                    <p>
                        <strong>Örnek : </strong>
                        Asagidaki bahis icin, tablodaki adreslerden, karsilarindaki miktar kadar, her hayvana bahis
                        yatırılmış olsun.

                    <h6>Hangisi uçabilir?</h6>
                    <table class="table table-striped table-bordered table-sm">
                        <thead class="text-center">
                            <tr>
                                <th colspan="2">Kedi</th>
                                <th colspan="2">At</th>
                                <th colspan="2">Kuş</th>
                            </tr>
                            <tr>
                                <th>Addr</th>
                                <th>Amount</th>
                                <th>Addr</th>
                                <th>Amount</th>
                                <th>Addr</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>7aa11...</td>
                                <td class="text-center">100</td>
                                <td>7aa22...</td>
                                <td class="text-center">50</td>
                                <td>7aa33...</td>
                                <td class="text-center">200</td>
                            </tr>
                            <tr>
                                <td>7bb11...</td>
                                <td class="text-center">50</td>
                                <td>7bb22...</td>
                                <td class="text-center">20</td>
                                <td>7bb33...</td>
                                <td class="text-center">300</td>
                            </tr>
                            <tr>
                                <td>7cc11...</td>
                                <td class="text-center">250</td>
                                <td>7cc22...</td>
                                <td class="text-center">30</td>
                                <td>7cc33...</td>
                                <td class="text-center">50</td>
                            </tr>
                            <tr>
                                <td>7dd11...</td>
                                <td class="text-center">300</td>
                                <td>7dd22...</td>
                                <td class="text-center">120</td>
                                <td>&nbsp;</td>
                                <td class="text-center">&nbsp;</td>
                            </tr>
                            <tr>
                                <td>&nbsp;</td>
                                <td class="text-center">&nbsp;</td>
                                <td>7ee22...</td>
                                <td class="text-center">60</td>
                                <td>&nbsp;</td>
                                <td class="text-center">&nbsp;</td>
                            </tr>
                            <tr>
                                <td>&nbsp;</td>
                                <td class="text-center">&nbsp;</td>
                                <td>7ff22...</td>
                                <td class="text-center">70</td>
                                <td>&nbsp;</td>
                                <td class="text-center">&nbsp;</td>
                            </tr>
                        </tbody>
                    </table>

                    <table class="table table-striped">
                        <tr>
                            <td>Toplam yatırılan</td>
                            <td>1600</td>
                            <td>&nbsp;</td>
                        </tr>
                        <tr>
                            <td>Kasaya kalan</td>
                            <td>32</td>
                            <td>1600 un %2 si</td>
                        </tr>
                        <tr>
                            <td>Paylaştırılacak olan</td>
                            <td>1568</td>
                            <td>1600 - 32</td>
                        </tr>
                    </table>

                    <br>
                    Kazanan <b>Kuş</b> <br>

                    <table class="table table-striped">
                        <tr>
                            <td>Kuş için yatırılan toplam</td>
                            <td>550</td>
                            <td>200 + 300 + 50</td>
                        </tr>
                    </table>

                    <br>
                    <b>Ödüller</b> <br>

                    <table class="table table-striped">
                        <tr>
                            <td>7aa33...</td>
                            <td>570.18</td>
                            <td>200 * (1568 / 550)</td>
                        </tr>
                        <tr>
                            <td>7bb33...</td>
                            <td>855.27</td>
                            <td>300 * (1568 / 550)</td>
                        </tr>
                        <tr>
                            <td>7cc33...</td>
                            <td>142.54</td>
                            <td>50 * (1568 / 550)</td>
                        </tr>
                    </table>
                    </p>

                    <h3>Nasıl alırım</h3>
                    <p>Kazananların adreslerine, bahis icin koinin gonderildigi adrese, gönderilir.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <main id="app">
        <div class="container py-4">
            <header class="pb-3 mb-4 border-bottom position-relative">
                <a href="/" class="d-flex align-items-center text-dark text-decoration-none">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="32" class="me-2" viewBox="0 0 118 94"
                        role="img">
                        <defs>
                            <linearGradient id="sw-gradient" x1="0" x2="1" y1="1" y2="0">
                                <stop id="stop1" stop-color="rgba(248, 117, 55, 1)" offset="0%"></stop>
                                <stop id="stop2" stop-color="rgba(251, 168, 31, 1)" offset="100%"></stop>
                            </linearGradient>
                        </defs>
                        <title>Quicky BET</title>
                        <path fill="url(#sw-gradient)"
                            d="M13.2,-17.5C20.6,-12.8,32.4,-13.6,33.8,-10.7C35.2,-7.8,26,-1.1,22.3,6.3C18.6,13.8,20.4,22.1,17.6,22.7C14.7,23.4,7.4,16.3,0.9,15.1C-5.6,13.9,-11.3,18.6,-18,19.3C-24.8,19.9,-32.7,16.6,-33.4,11.5C-34.1,6.5,-27.6,-0.2,-23,-5.2C-18.3,-10.3,-15.4,-13.7,-11.8,-19.8C-8.3,-25.8,-4.2,-34.4,-0.6,-33.5C2.9,-32.7,5.8,-22.3,13.2,-17.5Z"
                            width="100%" height="100%" transform="translate(50 50)" stroke-width="0"
                            style="transition: all 0.3s ease 0s;"></path>
                    </svg>
                    <span class="fs-4">Quicky BET <sub class="fs-6 fw-lighter "><small>bet just in five minutes
                                ;)</small></sub> </span>
                </a>
                <button type="button"
                    class="btn btn-link btn-sm text-dark text-decoration-none fs-6 fw-lighter position-absolute bottom-0 end-0"
                    data-bs-toggle="modal" data-bs-target="#howis">
                    But how?
                </button>
            </header>

            <div class="p-5 mb-4 bg-light rounded-3">
                <div id="b-datail" class="container-fluid py-5">
                </div>
            </div>

            <div id="b-opts" class="row d-flex justify-content-between">
            </div>

            <footer class="pt-3 mt-4 text-muted border-top">
                Kristal Technology &copy; 2022 - ...
            </footer>
        </div>
    </main>
</body>

</html>

<script>
    let B = null;
    let P = {};

    function render() {
        if (B == null) {
            document.getElementById("b-datail").innerHTML = "There is no active bet"
            document.getElementById("b-opts").classList.remove("d-flex");
            document.getElementById("b-opts").classList.add("d-none");
        } else {
            let total = 0;
            B.opts.forEach(o => {
                if (P[o.address] && P[o.address].pays) {
                    P[o.address]["tot"] = P[o.address].pays.reduce((tot, val) => tot += val.amount * 1, 0);
                    total += P[o.address]["tot"];
                }
            });

            document.getElementById("b-datail").innerHTML =
                `<h1 class="display-5 fw-bold">${B.name}</h1>
                    <p class="col-md-8 fs-4">${B.content}</p>
                    End time : <time datetime="${B.endtime}">${B.endtime}</time> <br>
                    Total amount : <span> ${formatPrice(total)}</span>`;

            let bOptsContent =
                B.opts.map(v => {

                    let payList = P[v.address] && P[v.address].pays && P[v.address].pays.map(p =>
                        `<tr>
                        <td data-bs-toggle="tooltip" data-bs-placement="top" title="${p.txid}">
                            ${p.addressfrom}</td>
                        <td>${formatPrice(p.amount)}</td>
                        <td>${(p.amount * (total * 98 / 100) / P[v.address].tot).toFixed(2)}</td>
                    </tr>`
                    ).join('');

                    return `<div class="col-md-5 m-2">
                    <div class="h-100 p-5 bg-light border rounded-3">
                        <strong>${v.content}</strong>
                        <p>To bet this option, send 777 coins to <strong>${v.address}</strong></p>

                        <div>
                            <strong>Payments</strong>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Address</th>
                                        <th>Amount</th>
                                        <th>If you win</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${payList}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`
                }).join(' ');

            document.getElementById("b-opts").innerHTML = bOptsContent;
            document.getElementById("b-opts").classList.add("d-flex");
            document.getElementById("b-opts").classList.remove("d-none");

        };
    }

    function formatPrice(value) {
        let val = (value / 1).toFixed(2).replace('.', ',')
        return val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")
    }

    window.onload = () => {

        fetch('/api/v1/bet')
            .then((response) => response.json())
            .then((data) => {
                B = data

                if (B) {
                    B.opts.forEach(e => {
                        fetch('/api/v1/payments/' + e.address)
                            .then((response) => response.json())
                            .then((data) => {
                                P[e.address] = { pays: data }
                                render();
                            })
                    })
                }
            })
    }
</script>

<script src="/socket.io/socket.io.js"></script>
<script>
    io = io();
    io.on('connection', (socket) => {
        console.log('a user connected');
        socket.on('disconnect', () => {
            console.log('user disconnected');
        });
    });
    io.on('pay', function (d) {
        P[d.addressto].pays.push(d)
        render();
    });
</script>